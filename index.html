<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TUVN - Monitoreo T√©rmico Casa</title>
    <!-- Tailwind CSS para el dise√±o Azul y Rojo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fuente Google -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />

    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        /* Animaci√≥n suave para las tarjetas */
        .sensor-card {
            transition: all 0.3s ease;
        }
        .sensor-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        /* Animaci√≥n de parpadeo para el punto de estado */
        .ping-dot {
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        /* Gradiente de temperatura */
        .temp-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        /* Iconos de habitaciones con sombra */
        .room-icon {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen flex flex-col">

    <!-- HEADER INSTITUCIONAL (Azul y Rojo) -->
    <header class="bg-gradient-to-r from-blue-900 to-blue-800 text-white shadow-2xl border-b-4 border-red-600">
        <div class="container mx-auto px-4 py-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Logo y Nombre -->
            <div class="flex items-center gap-4">
                <div class="bg-white/20 backdrop-blur-sm p-3 rounded-2xl">
                    <i data-lucide="home" class="w-10 h-10 text-blue-100"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tight">TUVN</h1>
                    <p class="text-sm text-blue-200 font-semibold tracking-widest uppercase">MONITOREO T√âRMICO CASA INTELIGENTE</p>
                </div>
            </div>

            <!-- Estado de Conexi√≥n -->
            <div class="flex items-center gap-3 bg-white/10 backdrop-blur-sm px-6 py-3 rounded-2xl border border-blue-400/30">
                <div class="relative flex h-4 w-4">
                    <span id="pingDot" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75 hidden"></span>
                    <span id="staticDot" class="relative inline-flex rounded-full h-4 w-4 bg-red-500"></span>
                </div>
                <span id="statusText" class="text-sm font-mono text-red-200 font-bold">Desconectado</span>
            </div>
        </div>
    </header>

    <!-- BARRA DE INFORMACI√ìN -->
    <div class="bg-white/80 backdrop-blur-sm border-b border-slate-200 shadow-lg">
        <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center text-sm text-slate-700">
            <div class="flex items-center gap-3">
                <i data-lucide="user-circle" class="w-5 h-5 text-red-600"></i>
                <span class="font-semibold">Desarrollador: <span class="text-blue-900 font-bold">Guanochanga, Rodriguez</span></span>
            </div>
            <div class="flex gap-4 font-mono text-slate-500">
                <span id="dateDisplay">--/--/----</span>
                <span id="timeDisplay" class="text-blue-700 font-bold">--:--:--</span>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-grow container mx-auto px-4 py-12">
        
        <!-- T√≠tulo Principal -->
        <div class="text-center mb-12">
            <h2 class="text-5xl font-black bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent mb-4">
                Temperatura en Tiempo Real
            </h2>
            <p class="text-xl text-slate-600 font-medium">Sistema de monitoreo DS18B20 - Bus OneWire</p>
        </div>

        <!-- TEMPERATURA GENERAL (Term√≥metro anal√≥gico) -->
        <div class="max-w-2xl mx-auto mb-16">
          <div class="temp-gradient text-white rounded-3xl p-10 shadow-2xl text-center transform hover:scale-105 transition-all duration-300">
            <h3 class="text-2xl font-bold mb-6">üè† Temperatura General Casa</h3>
            
            <!-- Term√≥metro anal√≥gico SVG -->
            <svg width="120" height="300" viewBox="0 0 120 300" xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-4">
              <!-- Tubo del term√≥metro -->
              <rect x="50" y="20" width="20" height="220" rx="10" ry="10" fill="#d1d5db" />
              <!-- Mercurio (barra variable) -->
              <rect id="mercury" x="50" y="240" width="20" height="0" rx="10" ry="10" fill="#ef4444" />
              <!-- Bulbo -->
              <rcle cx="60" cy="270" r="30" fill="#ef4444" stroke="#b91c1c" stroke-width="4"/>
              <!-- Aguja -->
              <line id="needle" x1="60" y1="140" x2="60" y2="40" stroke="#b91c1c" stroke-width="5" stroke-linecap="round" transform="rotate(0,60,140)" />
              <!-- Marca central para pivote -->
              <rcle cx="60" cy="140" r="8" fill="#b91c1c" />
              
              <!-- Escala de temperatura (del 0 a 50 ¬∞C) -->
              <text x="80" y="245" font-size="12" fill="#374151">0¬∞C</text>
              <text x="80" y="45" font-size="12" fill="#374151">50¬∞C</text>
            </svg>
            
            <div class="text-7xl font-black mb-2" id="valGeneral">--</div>
            <div class="text-white/80 text-lg font-medium">¬∞C - Promedio de todas las habitaciones</div>
          </div>
        </div>

        <!-- GRID DE HABITACIONES con barras anal√≥gicas -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8 max-w-6xl mx-auto">

            <!-- Dormitorio -->
            <div class="sensor-card group bg-white/70 backdrop-blur-sm rounded-3xl overflow-hidden shadow-2xl border-2 border-slate-200/50 hover:border-blue-300">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-white font-black text-xl">üõèÔ∏è Dormitorio</h3>
                        <p class="text-blue-100 text-sm font-medium">Zona de descanso</p>
                    </div>
                    <i data-lucide="moon" class="text-blue-200 w-8 h-8 group-hover:rotate-12 transition-transform"></i>
                </div>
                <div class="p-8 text-center relative overflow-hidden flex flex-col items-center">
                    <svg width="40" height="120" viewBox="0 0 40 120" xmlns="http://www.w3.org/2000/svg" class="mb-4">
                        <rect x="15" y="10" width="10" height="100" rx="5" ry="5" fill="#e0e0e0"/>
                        <rect id="bar1" x="15" y="110" width="10" height="0" rx="5" ry="5" fill="#3b82f6" />
                        <rcle cx="20" cy="115" r="15" fill="#3b82f6"/>
                    </svg>
                    <div class="text-4xl font-black text-slate-800 mb-2 relative z-10" id="val1">--</div>
                    <div class="text-slate-500 text-lg font-semibold">¬∞C</div>
                </div>
            </div>

            <!-- Cocina -->
            <div class="sensor-card group bg-white/70 backdrop-blur-sm rounded-3xl overflow-hidden shadow-2xl border-2 border-slate-200/50 hover:border-orange-400">
                <div class="bg-gradient-to-r from-orange-600 to-red-600 p-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-white font-black text-xl">üç≥ Cocina</h3>
                        <p class="text-orange-100 text-sm font-medium">√Årea de preparaci√≥n</p>
                    </div>
                    <i data-lucide="utensils" class="text-orange-200 w-8 h-8 group-hover:rotate-12 transition-transform"></i>
                </div>
                <div class="p-8 text-center relative overflow-hidden flex flex-col items-center">
                    <svg width="40" height="120" viewBox="0 0 40 120" xmlns="http://www.w3.org/2000/svg" class="mb-4">
                        <rect x="15" y="10" width="10" height="100" rx="5" ry="5" fill="#e0e0e0"/>
                        <rect id="bar2" x="15" y="110" width="10" height="0" rx="5" ry="5" fill="#fb923c" />
                        <rcle cx="20" cy="115" r="15" fill="#fb923c"/>
                    </svg>
                    <div class="text-4xl font-black text-slate-800 mb-2 relative z-10" id="val2">--</div>
                    <div class="text-slate-500 text-lg font-semibold">¬∞C</div>
                </div>
            </div>

            <!-- Sala -->
            <div class="sensor-card group bg-white/70 backdrop-blur-sm rounded-3xl overflow-hidden shadow-2xl border-2 border-slate-200/50 hover:border-purple-400">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-white font-black text-xl">üì∫ Sala</h3>
                        <p class="text-purple-100 text-sm font-medium">√Årea familiar</p>
                    </div>
                    <i data-lucide="tv" class="text-purple-200 w-8 h-8 group-hover:rotate-12 transition-transform"></i>
                </div>
                <div class="p-8 text-center relative overflow-hidden flex flex-col items-center">
                    <svg width="40" height="120" viewBox="0 0 40 120" xmlns="http://www.w3.org/2000/svg" class="mb-4">
                        <rect x="15" y="10" width="10" height="100" rx="5" ry="5" fill="#e0e0e0"/>
                        <rect id="bar3" x="15" y="110" width="10" height="0" rx="5" ry="5" fill="#a78bfa" />
                        <rcle cx="20" cy="115" r="15" fill="#a78bfa"/>
                    </svg>
                    <div class="text-4xl font-black text-slate-800 mb-2 relative z-10" id="val3">--</div>
                    <div class="text-slate-500 text-lg font-semibold">¬∞C</div>
                </div>
            </div>

            <!-- Comedor -->
            <div class="sensor-card group bg-white/70 backdrop-blur-sm rounded-3xl overflow-hidden shadow-2xl border-2 border-slate-200/50 hover:border-emerald-400">
                <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-white font-black text-xl">üçΩÔ∏è Comedor</h3>
                        <p class="text-emerald-100 text-sm font-medium">Zona de comidas</p>
                    </div>
                    <i data-lucide="utensils-crossed" class="text-emerald-200 w-8 h-8 group-hover:rotate-12 transition-transform"></i>
                </div>
                <div class="p-8 text-center relative overflow-hidden flex flex-col items-center">
                    <svg width="40" height="120" viewBox="0 0 40 120" xmlns="http://www.w3.org/2000/svg" class="mb-4">
                        <rect x="15" y="10" width="10" height="100" rx="5" ry="5" fill="#e0e0e0"/>
                        <rect id="bar4" x="15" y="110" width="10" height="0" rx="5" ry="5" fill="#34d399" />
                        <rcle cx="20" cy="115" r="15" fill="#34d399"/>
                    </svg>
                    <div class="text-4xl font-black text-slate-800 mb-2 relative z-10" id="val4">--</div>
                    <div class="text-slate-500 text-lg font-semibold">¬∞C</div>
                </div>
            </div>

        </div>

        <!-- BOT√ìN CONECTAR PRINCIPAL -->
        <div class="mt-20 flex justify-center">
            <button id="connectBtn" onclick="toggleConnection()" class="group bg-gradient-to-r from-slate-800 to-slate-900 hover:from-slate-900 hover:to-gray-900 text-white font-black py-6 px-16 rounded-3xl shadow-2xl flex items-center gap-4 transition-all duration-300 hover:scale-110 active:scale-105 border-4 border-slate-200/50 hover:border-slate-300/50">
                <i data-lucide="bluetooth" class="w-8 h-8 group-hover:animate-pulse"></i>
                <span class="text-xl tracking-wide uppercase">CONECTAR SISTEMA</span>
                <div class="w-3 h-3 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full group-hover:animate-ping"></div>
            </button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-slate-900 to-gray-900 text-slate-400 py-8 text-center border-t-4 border-red-600">
        <p class="text-sm font-medium">¬© 2025 Instituto Superior Tecnol√≥gico Vida Nueva - Automatizaci√≥n e Instrumentaci√≥n</p>
    </footer>

    <!-- JAVASCRIPT L√ìGICO -->
    <script>
        // Inicializar iconos
        lucide.createIcons();

        // --- 1. RELOJ AUTOM√ÅTICO ---
        function updateClock() {
            const now = new Date();
            const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('es-EC', optionsDate);
            document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('es-EC');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- 2. L√ìGICA BLUETOOTH ---
        const serviceUuid = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const characteristicUuid = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let bluetoothDevice;
        let bleCharacteristic;

        // Referencias UI
        const connectBtn = document.getElementById('connectBtn');
        const statusText = document.getElementById('statusText');
        const pingDot = document.getElementById('pingDot');
        const staticDot = document.getElementById('staticDot');
        const val1 = document.getElementById('val1');
        const val2 = document.getElementById('val2');
        const val3 = document.getElementById('val3');
        const val4 = document.getElementById('val4');
        const valGeneral = document.getElementById('valGeneral');

        async function toggleConnection() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                disconnect();
            } else {
                connect();
            }
        }

        async function connect() {
            try {
                connectBtn.innerHTML = '<span class="animate-spin w-8 h-8">üîÑ</span> <span>CONECTANDO...</span>';
                
                console.log('Buscando dispositivo...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TUVN_Termometros' }],
                    optionalServices: [serviceUuid]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(serviceUuid);
                bleCharacteristic = await service.getCharacteristic(characteristicUuid);

                await bleCharacteristic.startNotifications();
                bleCharacteristic.addEventListener('characteristicvaluechanged', handleData);

                console.log('¬°Conectado!');
                updateUIConnected();

            } catch (error) {
                console.log('Error de conexi√≥n:', error);
                updateUIDisconnected();
            }
        }

        function disconnect() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
        }

        function onDisconnected() {
            console.log('Desconectado.');
            updateUIDisconnected();
        }

        // --- 3. PROCESAMIENTO DE DATOS ---
        function handleData(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const jsonString = decoder.decode(value);

            console.log("Dato recibido:", jsonString);

            try {
                const data = JSON.parse(jsonString);

                if(data.s1 !== undefined){
                    val1.innerText = data.s1.toFixed(1);
                    let height = (data.s1 / 50) * 100; // escala 0-50 ¬∞C altura barra habitaci√≥n
                    const bar1 = document.getElementById('bar1');
                    bar1.setAttribute('height', height);
                    bar1.setAttribute('y', 110 - height);
                }
                if(data.s2 !== undefined){
                    val2.innerText = data.s2.toFixed(1);
                    let height = (data.s2 / 50) * 100;
                    const bar2 = document.getElementById('bar2');
                    bar2.setAttribute('height', height);
                    bar2.setAttribute('y', 110 - height);
                }
                if(data.s3 !== undefined){
                    val3.innerText = data.s3.toFixed(1);
                    let height = (data.s3 / 50) * 100;
                    const bar3 = document.getElementById('bar3');
                    bar3.setAttribute('height', height);
                    bar3.setAttribute('y', 110 - height);
                }
                if(data.s4 !== undefined){
                    val4.innerText = data.s4.toFixed(1);
                    let height = (data.s4 / 50) * 100;
                    const bar4 = document.getElementById('bar4');
                    bar4.setAttribute('height', height);
                    bar4.setAttribute('y', 110 - height);
                }

                let temps = [];
                if(data.s1 !== undefined) temps.push(data.s1);
                if(data.s2 !== undefined) temps.push(data.s2);
                if(data.s3 !== undefined) temps.push(data.s3);
                if(data.s4 !== undefined) temps.push(data.s4);
                if(temps.length > 0){
                    const avg = temps.reduce((a,b) => a+b, 0) / temps.length;
                    valGeneral.innerText = avg.toFixed(1);

                    // Ajustar barra roja del mercurio (m√°x 220 de altura)
                    const mercuryHeight = (avg / 50) * 220;
                    const mercury = document.getElementById('mercury');
                    mercury.setAttribute('height', mercuryHeight);
                    mercury.setAttribute('y', 240 - mercuryHeight);

                    // Rotar aguja del term√≥metro (de -90¬∞ a 90¬∞)
                    const needle = document.getElementById('needle');
                    const angle = (avg / 50) * 180 - 90;
                    needle.setAttribute('transform', `rotate(${angle}, 60, 140)`);
                }

                // Efecto visual
                pingDot.classList.remove('hidden');
                setTimeout(() => pingDot.classList.add('hidden'), 500);

            } catch (e) {
                console.error("Error al leer JSON:", e);
            }
        }

        // --- FUNCIONES UI ---
        function updateUIConnected() {
            connectBtn.innerHTML = '<i data-lucide="bluetooth" class="w-8 h-8"></i> <span>DESCONECTAR</span> <div class="w-3 h-3 bg-emerald-400 rounded-full animate-ping"></div>';
            connectBtn.className = 'group bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-black py-6 px-16 rounded-3xl shadow-2xl flex items-center gap-4 transition-all duration-300 hover:scale-110 active:scale-105 border-4 border-emerald-200/50 hover:border-emerald-300/50';

            statusText.innerText = "CONECTADO";
            statusText.classList.replace('text-red-200', 'text-emerald-400');
            staticDot.classList.replace('bg-red-500', 'bg-emerald-500');
            lucide.createIcons();
        }

        function updateUIDisconnected() {
            connectBtn.innerHTML = '<i data-lucide="bluetooth" class="w-8 h-8 group-hover:animate-pulse"></i> <span class="text-xl tracking-wide uppercase">CONECTAR SISTEMA</span> <div class="w-3 h-3 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full group-hover:animate-ping"></div>';
            connectBtn.className = 'group bg-gradient-to-r from-slate-800 to-slate-900 hover:from-slate-900 hover:to-gray-900 text-white font-black py-6 px-16 rounded-3xl shadow-2xl flex items-center gap-4 transition-all duration-300 hover:scale-110 active:scale-105 border-4 border-slate-200/50 hover:border-slate-300/50';
            lucide.createIcons();

            statusText.innerText = "DESCONECTADO";
            statusText.classList.replace('text-emerald-400', 'text-red-200');
            staticDot.classList.replace('bg-emerald-500', 'bg-red-500');
            pingDot.classList.add('hidden');

            val1.innerText = "--"; val2.innerText = "--"; val3.innerText = "--"; val4.innerText = "--"; valGeneral.innerText = "--";

            // Reset barras y term√≥metro
            const mercury = document.getElementById('mercury');
            mercury.setAttribute('height', 0);
            mercury.setAttribute('y', 240);

            ['bar1','bar2','bar3','bar4'].forEach(id => {
                const bar = document.getElementById(id);
                bar.setAttribute('height', 0);
                bar.setAttribute('y', 110);
            });

            const needle = document.getElementById('needle');
            needle.setAttribute('transform', 'rotate(0, 60, 140)');
        }
    </script>
</body>
</html>
